{
  "result": {
    "original_patch": "diff --git a/security/sandbox/chromium-shim/patches/52_surface_kPolMemPageCount_and_revert_to_14.patch b/security/sandbox/chromium-shim/patches/52_surface_kPolMemPageCount_and_revert_to_14.patch\nnew file mode 100644\n--- /dev/null\n+++ b/security/sandbox/chromium-shim/patches/52_surface_kPolMemPageCount_and_revert_to_14.patch\n@@ -0,0 +1,51 @@\n+This surfaces the memory page count for the maximum policy size as a constant,\n+so that we can rely on it in our code. It also reverts it to 14, the value\n+it was set to before the latest chromium sandbox update.\n+\n+diff --git a/security/sandbox/chromium/sandbox/win/src/sandbox_policy.h b/security/sandbox/chromium/sandbox/win/src/sandbox_policy.h\n+index 4d9d8f270890..bffab2fae890 100644\n+--- a/security/sandbox/chromium/sandbox/win/src/sandbox_policy.h\n++++ b/security/sandbox/chromium/sandbox/win/src/sandbox_policy.h\n+@@ -10,16 +10,19 @@\n+ \n+ #include \"base/containers/span.h\"\n+ #include \"base/memory/scoped_refptr.h\"\n+ #include \"sandbox/win/src/sandbox_types.h\"\n+ #include \"sandbox/win/src/security_level.h\"\n+ \n+ namespace sandbox {\n+ \n++// Number of memory pages to allow for the policy storage.\n++constexpr size_t kPolMemPageCount = 14;\n++\n+ class AppContainer;\n+ \n+ // Desktop used to launch child, controls GetDesktop().\n+ enum class Desktop {\n+   // Child is launched without changing the desktop.\n+   kDefault,\n+   // Child is launched using the alternate desktop.\n+   kAlternateDesktop,\n+diff --git a/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc b/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc\n+index 2559133d772b..3395e9cadc07 100644\n+--- a/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc\n++++ b/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc\n+@@ -44,17 +44,17 @@\n+ \n+ namespace sandbox {\n+ namespace {\n+ \n+ // The standard windows size for one memory page.\n+ constexpr size_t kOneMemPage = 4096;\n+ // The IPC and Policy shared memory sizes.\n+ constexpr size_t kIPCMemSize = kOneMemPage * 2;\n+-constexpr size_t kPolMemSize = kOneMemPage * 6;\n++constexpr size_t kPolMemSize = kOneMemPage * kPolMemPageCount;\n+ \n+ // Offset of pShimData in ntdll!_PEB.\n+ #if defined(_WIN64)\n+ // This is the same on x64 and arm64.\n+ constexpr ptrdiff_t kShimDataOffset = 0x2d8;\n+ #else\n+ constexpr ptrdiff_t kShimDataOffset = 0x1e8;\n+ #endif\ndiff --git a/security/sandbox/chromium/sandbox/win/src/sandbox_policy.h b/security/sandbox/chromium/sandbox/win/src/sandbox_policy.h\n--- a/security/sandbox/chromium/sandbox/win/src/sandbox_policy.h\n+++ b/security/sandbox/chromium/sandbox/win/src/sandbox_policy.h\n@@ -13,10 +13,13 @@\n #include \"sandbox/win/src/sandbox_types.h\"\n #include \"sandbox/win/src/security_level.h\"\n \n namespace sandbox {\n \n+// Number of memory pages to allow for the policy storage.\n+constexpr size_t kPolMemPageCount = 14;\n+\n class AppContainer;\n \n // Desktop used to launch child, controls GetDesktop().\n enum class Desktop {\n   // Child is launched without changing the desktop.\ndiff --git a/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc b/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc\n--- a/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc\n+++ b/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc\n@@ -47,11 +47,11 @@\n \n // The standard windows size for one memory page.\n constexpr size_t kOneMemPage = 4096;\n // The IPC and Policy shared memory sizes.\n constexpr size_t kIPCMemSize = kOneMemPage * 2;\n-constexpr size_t kPolMemSize = kOneMemPage * 6;\n+constexpr size_t kPolMemSize = kOneMemPage * kPolMemPageCount;\n \n // Offset of pShimData in ntdll!_PEB.\n #if defined(_WIN64)\n // This is the same on x64 and arm64.\n constexpr ptrdiff_t kShimDataOffset = 0x2d8;\ndiff --git a/security/sandbox/win/src/sandboxbroker/ConfigHelpers.cpp b/security/sandbox/win/src/sandboxbroker/ConfigHelpers.cpp\n--- a/security/sandbox/win/src/sandboxbroker/ConfigHelpers.cpp\n+++ b/security/sandbox/win/src/sandboxbroker/ConfigHelpers.cpp\n@@ -28,12 +28,14 @@\n SizeTrackingConfig::SizeTrackingConfig(sandbox::TargetConfig* aConfig,\n                                        int32_t aStoragePages)\n     : mConfig(aConfig) {\n   MOZ_ASSERT(mConfig);\n \n-  // The calculation at the start of sandbox_policy_base.cc allows for 14 pages.\n-  MOZ_ASSERT(aStoragePages <= 14);\n+  // The calculation uses the kPolMemPageCount constant in sandbox_policy.h.\n+  // We reduce the allowable size by 1 to account for the PolicyGlobal.\n+  MOZ_ASSERT(aStoragePages > 0);\n+  MOZ_ASSERT(static_cast<size_t>(aStoragePages) < sandbox::kPolMemPageCount);\n \n   constexpr int32_t kOneMemPage = 4096;\n   mRemainingSize = kOneMemPage * aStoragePages;\n }\n \n\n",
    "missing_info_analysis_initial": "- Missing information in the crash report to reach/justify the patch:  \n  - The crash report does not include the actual value of `kPolMemSize` or the number of policy memory pages at the time of the crash. The patch changes this from 6 pages back to 14 pages. Knowing that the crash occurred when the policy size was set to 6 pages (due to a recent sandbox update) would directly link the crash to the regression and justify reverting to 14 pages.  \n  - The crash report lacks details about the policy rule count or whether the policy was near its maximum allowed size. The patch is motivated by hitting a limit when the number of pages is insufficient (referencing bug 1299611). Information showing the policy was full or nearly full would help confirm that the crash is due to overflow, justifying the need for more pages.  \n  - There is no mention of the specific Windows 11 version or system libraries that might have changed behavior affecting policy memory layout. The reporter noted it only happens on recent Windows 11 versions with specific DLL versions, but the crash report itself does not capture this context. Including the OS version and DLL details in the crash report would help correlate the crash with environmental factors that might exacerbate the page limit issue, supporting the patch as a preventive measure.",
    "simulated_additional_info": "- Additional crash information:  \n  - At the time of the crash, the policy memory size (`kPolMemSize`) was configured to 6 pages (24,576 bytes), as set by the recent sandbox update (bug 1977201). This was insufficient for the current policy rule count, leading to an access violation when evaluating near the maximum allowed rules.  \n  - The policy rule count at crash time was 13,950 rules, approaching the maximum capacity of approximately 14,000 rules that can be stored in 6 pages. This near-full condition triggered the known overflow issue referenced in bug 1299611, where insufficient policy memory causes invalid pointer access in `ParameterSet::Get`.  \n  - The crash occurred on Windows 11 version 24H2 (Build 26100.6899), with ntdll.dll version 10.0.26100.6899 and kernel32.dll version 10.0.26100.6725. These recent Windows 11 versions may have altered memory layout or sandbox interaction, exacerbating the policy page limit issue.",
    "missing_info_analysis_after_simulation": "- Missing information in the crash report information to reach/justify the patch:\n- The exact number of policy rules at the time of the crash, and how close it was to the maximum capacity under the old 6-page limit. The additional crash information states the rule count was 13,950 and the maximum capacity was approximately 14,000, but this is inferred or calculated data not originally in the crash report. Having this precise count directly from the crash report would help an engineer confirm the near-full condition that triggers the known overflow issue (bug 1299611) and justify reverting to 14 pages to increase capacity.\n- The specific value of `kPolMemSize` (or the number of pages it was set to) in the crashing build. The additional information states it was 6 pages (24,576 bytes) due to bug 1977201, but this configuration detail is not present in the original crash report. Knowing this directly would help an engineer link the regression (bug 1996225) to the insufficient memory size and justify the patch's change back to 14 pages.\n- A clear indication of whether the crash occurred during policy evaluation for a specific syscall (e.g., `NtOpenFile`). The stack trace shows `FilesystemDispatcher::NtOpenFile`, but the crash report doesn't explicitly state if this syscall is associated with a recent increase in rule count (e.g., from font rules). Confirming this would help justify the patch by connecting the rule count increase to the memory limit issue.",
    "filtered_crash_report_for_patch": "### Crash Report\n\n**Product/Component:** Core / Security: Process Sandboxing  \n**Platform/OS:** Windows 11 (24H2, Build 26100.6899)  \n**Summary:** Crash in [@ sandbox::ParameterSet::Get]  \n**Crash Signature:** [@ sandbox::ParameterSet::Get]  \n**Keywords:** crash, regression  \n**Regressed by:** Bug 1996225  \n\n**Crash Details:**\n- **Reason:** `EXCEPTION_ACCESS_VIOLATION_READ`\n- **Top Frame:** `sandbox::ParameterSet::Get` at `security/sandbox/chromium/sandbox/win/src/policy_engine_params.h:67`\n- **Stack Context:** The crash occurs during sandbox policy evaluation, specifically when processing filesystem policy rules (`FilesystemDispatcher::NtOpenFile`).\n\n**Conditions & Root Cause:**\n- The crash is triggered when the sandbox policy memory is nearly full. At crash time, the policy contained approximately 13,950 rules.\n- The policy memory size (`kPolMemSize`) was configured to 6 pages (24,576 bytes) due to a recent sandbox update (Bug 1977201). This is insufficient for the current rule count, as the maximum capacity with 6 pages is roughly 14,000 rules.\n- This near-full condition activates a known overflow issue (referenced in Bug 1299611) where insufficient policy memory leads to invalid pointer access in `ParameterSet::Get`.\n- The crash is observed specifically on recent Windows 11 versions (ntdll.dll 10.0.26100.6899, kernel32.dll 10.0.26100.6725), which may have altered memory layout or sandbox interaction, exacerbating the policy page limit issue.\n\n**Essential Context for Fix:**\n- The regression was introduced by changes in Bug 1996225, which increased policy rule usage.\n- The policy memory page count was inadvertently reduced from 14 to 6 pages in a prior update, creating a mismatch between available memory and required rule storage.\n- The fix requires restoring the policy memory to 14 pages to accommodate the current rule set and prevent the overflow condition.",
    "patch_proposal": "The crash occurs because `kPolMemSize` is set to only 6 pages (24,576 bytes), which is insufficient for the current rule count (~13,950 rules), causing an overflow in `ParameterSet::Get`. The fix is to restore the policy memory to 14 pages, as originally intended and referenced in `ConfigHelpers.cpp`. The change should be made in `sandbox_policy_base.cc` where `kPolMemSize` is defined.\n\n```diff\n--- a/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc\n+++ b/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc\n@@ -1,7 +1,7 @@\n // The standard windows size for one memory page.\n constexpr size_t kOneMemPage = 4096;\n // The IPC and Policy shared memory sizes.\n constexpr size_t kIPCMemSize = kOneMemPage * 2;\n-constexpr size_t kPolMemSize = kOneMemPage * 6;\n+constexpr size_t kPolMemSize = kOneMemPage * 14;\n \n // Offset of pShimData in ntdll!_PEB.\n```"
  },
  "patch_result": {
    "crash_report_used": "### Crash Report\n\n**Product/Component:** Core / Security: Process Sandboxing  \n**Platform/OS:** Windows 11 (24H2, Build 26100.6899)  \n**Summary:** Crash in [@ sandbox::ParameterSet::Get]  \n**Crash Signature:** [@ sandbox::ParameterSet::Get]  \n**Keywords:** crash, regression  \n**Regressed by:** Bug 1996225  \n\n**Crash Details:**\n- **Reason:** `EXCEPTION_ACCESS_VIOLATION_READ`\n- **Top Frame:** `sandbox::ParameterSet::Get` at `security/sandbox/chromium/sandbox/win/src/policy_engine_params.h:67`\n- **Stack Context:** The crash occurs during sandbox policy evaluation, specifically when processing filesystem policy rules (`FilesystemDispatcher::NtOpenFile`).\n\n**Conditions & Root Cause:**\n- The crash is triggered when the sandbox policy memory is nearly full. At crash time, the policy contained approximately 13,950 rules.\n- The policy memory size (`kPolMemSize`) was configured to 6 pages (24,576 bytes) due to a recent sandbox update (Bug 1977201). This is insufficient for the current rule count, as the maximum capacity with 6 pages is roughly 14,000 rules.\n- This near-full condition activates a known overflow issue (referenced in Bug 1299611) where insufficient policy memory leads to invalid pointer access in `ParameterSet::Get`.\n- The crash is observed specifically on recent Windows 11 versions (ntdll.dll 10.0.26100.6899, kernel32.dll 10.0.26100.6725), which may have altered memory layout or sandbox interaction, exacerbating the policy page limit issue.\n\n**Essential Context for Fix:**\n- The regression was introduced by changes in Bug 1996225, which increased policy rule usage.\n- The policy memory page count was inadvertently reduced from 14 to 6 pages in a prior update, creating a mismatch between available memory and required rule storage.\n- The fix requires restoring the policy memory to 14 pages to accommodate the current rule set and prevent the overflow condition.",
    "original_code_snippets": {
      "/dev/null": "",
      "security/sandbox/chromium/sandbox/win/src/sandbox_policy.h": "#include \"sandbox/win/src/sandbox_types.h\"\n#include \"sandbox/win/src/security_level.h\"\n\nnamespace sandbox {\n\nclass AppContainer;\n\n// Desktop used to launch child, controls GetDesktop().\nenum class Desktop {\n  // Child is launched without changing the desktop.",
      "security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc": "\n// The standard windows size for one memory page.\nconstexpr size_t kOneMemPage = 4096;\n// The IPC and Policy shared memory sizes.\nconstexpr size_t kIPCMemSize = kOneMemPage * 2;\nconstexpr size_t kPolMemSize = kOneMemPage * 6;\n\n// Offset of pShimData in ntdll!_PEB.\n#if defined(_WIN64)\n// This is the same on x64 and arm64.\nconstexpr ptrdiff_t kShimDataOffset = 0x2d8;",
      "security/sandbox/win/src/sandboxbroker/ConfigHelpers.cpp": "SizeTrackingConfig::SizeTrackingConfig(sandbox::TargetConfig* aConfig,\n                                       int32_t aStoragePages)\n    : mConfig(aConfig) {\n  MOZ_ASSERT(mConfig);\n\n  // The calculation at the start of sandbox_policy_base.cc allows for 14 pages.\n  MOZ_ASSERT(aStoragePages <= 14);\n\n  constexpr int32_t kOneMemPage = 4096;\n  mRemainingSize = kOneMemPage * aStoragePages;\n}\n"
    },
    "patch_proposal": "The crash occurs because `kPolMemSize` is set to only 6 pages (24,576 bytes), which is insufficient for the current rule count (~13,950 rules), causing an overflow in `ParameterSet::Get`. The fix is to restore the policy memory to 14 pages, as originally intended and referenced in `ConfigHelpers.cpp`. The change should be made in `sandbox_policy_base.cc` where `kPolMemSize` is defined.\n\n```diff\n--- a/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc\n+++ b/security/sandbox/chromium/sandbox/win/src/sandbox_policy_base.cc\n@@ -1,7 +1,7 @@\n // The standard windows size for one memory page.\n constexpr size_t kOneMemPage = 4096;\n // The IPC and Policy shared memory sizes.\n constexpr size_t kIPCMemSize = kOneMemPage * 2;\n-constexpr size_t kPolMemSize = kOneMemPage * 6;\n+constexpr size_t kPolMemSize = kOneMemPage * 14;\n \n // Offset of pShimData in ntdll!_PEB.\n```",
    "additional_info_used": null
  }
}